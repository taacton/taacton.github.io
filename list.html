<html>
    <head>
        <title>Toolbox</title>
        <link rel="icon" href="favicon.ico" type="image/gif" sizes="64x64">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    </head>
    <body>
        <nav>
            <div class="nav-wrapper" style="background-color: #26a69a;">
                <a href="index.html" class="brand-logo" style="margin-left: 10px;">Tom's Toolbox</a>
                <ul class="right hide-on-med-and-down">
                    <li><a href="index.html">...</a></li>
                    <li class="active"><a href="list.html">List validator</a></li>
                    <li><a href="converter.html">App ID converter</a></li>
                </ul>
            </div>
        </nav>

        <div class="container">
            <h1>Test</h1>
            <div class="row">
                <div class="col s8">
                    <input type="file" id="input" onchange="validateFiles(this.files)">
                </div>
                <br>
                <button type="button" id="fixFiles" onclick="fixFiles()" disabled="true">Fix!</button>   
            </div>
        </div>

        <script>
            function validateFiles(files) {
                const numFiles = files.length;
                console.log(numFiles + " file(s) uploaded sucsessfully.")
                var errors = 0;
                for (let i = 0, numFiles = files.length; i < numFiles; i++) {
                    if (files[i].type != "text/csv") {
                        M.toast({html: `File ${i + 1} is not a CSV, please check and re-upload the file as a CSV!`, displayLength: 10000});
                        errors ++;
                    }
                }
                if (errors === 0) {
                    $("#fixFiles").attr("disabled", false);
                }
            }
            
            function fixFiles() {
                const files = $("#input")[0].files
                 , numFiles = files.length;
                var reader = new FileReader()
                reader.onload = function(e) {
                        var content = reader.result;
                        content = JSON.stringify(content);
                        content = content.replace(/(?:\\[rn])+/g, "\n");
                        content = content.replace(/"/g, "");
                        console.log(content);
                        var element = document.createElement('a');
                        element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(content));
                        element.setAttribute('download', "fixed_file.csv");
                        element.style.display = 'none';
                        document.body.appendChild(element);
                        element.click();
                        document.body.removeChild(element);
                }
                for (let i = 0, numFiles = files.length; i < numFiles; i++) {
                    reader.readAsText(files[i]);
                }
            }
        </script>
    </body>
</html>