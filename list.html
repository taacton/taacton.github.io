<html>
    <head>
        <title>Toolbox</title>
        <link rel="icon" href="favicon.ico" type="image/gif" sizes="64x64">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    </head>
    <body>
        <nav>
            <div class="nav-wrapper" style="background-color: #26a69a;">
                <a href="index.html" class="brand-logo" style="margin-left: 10px;">Tom's Toolbox</a>
                <ul class="right hide-on-med-and-down">
                    <li><a href="index.html">...</a></li>
                    <li class="active"><a href="list.html">List Fixer</a></li>
                    <li><a href="converter.html">App ID Converter</a></li>
                </ul>
            </div>
        </nav>

        <div class="container">
            <h1>Targeting list fixer</h1>
            <p>If you recieve a targeting list and can't upload it to the DSP, this tool will try to fix common issues with the file.</p>  
            <p>Specifically this tool will remove hidden charchters, correct line-endings and validate the IDFA is valid.</p>
            <br>
            <div class="row">
                <div class="col s8">
                    <label for="input">Upload file(s):</label>
                    <input type="file" id="input" style="color: white;" onchange="fixFiles(this.files)" accept="text/csv" multiple>  
                </div>                 
            </div>
        </div>
        <script>     
            function fixFiles(files) {
                const numFiles = files.length;
                M.toast({html: `${numFiles} file(s) sucsessfully uploaded`, displayLength: 10000});
                var name = ""
                 , reader = [];
                for (let i = 0, numFiles = files.length; i < numFiles; i++) {                    
                    console.log(`Processing file: ${files[i].name}`);
                    name = files[i].name.replace(".csv", "");
                    reader.push(new FileReader());
                    reader[i].onload = function(e) {
                        var content = reader[i].result;
                        content = JSON.stringify(content);
                        content = content.replace(/(?:\\[rn])+/g, "\n");
                        // Add REGEX validation
                        content = content.replace(/"/g, "");
                        var el = document.createElement("a");
                        el.setAttribute("href", "data:text/csv;charset=utf-8," + encodeURIComponent(content));
                        el.style.display = "none";
                        document.body.appendChild(el);
                        el.setAttribute('download', `${name}_fixed.csv`); // Name doesn't update properly, always has the name of the first file processed
                        el.click();
                        document.body.removeChild(el);
                    }
                    reader[i].readAsText(files[i]);                
                }
            }
        </script>
    </body>
</html>